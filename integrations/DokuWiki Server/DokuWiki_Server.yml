commonfields:
  id: DokuWiki Server
  version: -1
vcShouldKeepItemLegacyProdMachine: false
name: DokuWiki Server
display: DokuWiki Server
category: Utilities
image: data:image/png;base64,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
description: DokuWiki Server on XSOAR
detaileddescription: |-
  ### How to configure an instance.

  #### 0.  Go to ABOUT > Troubleshooting > Server Configuration
    Set  instance.execute.external = true

  #### 1. Create an instance
  Add instance with the parameters below:
    - Instance Name: dokuwiki
    - Listen Port: 8280

  You can access the webmail UI at
    - https://xsoar-server/instance/execute/dokuwiki/
    - http://xsoar-server:8280/

  Installer UI
    - https://xsoar-server/instance/execute/dokuwiki/install.php
    - http://xsoar-server:8118/install.php

  Restore from backup
    - https://xsoar-server/instance/execute/dokuwiki/restore.php
    - http://xsoar-server:8118/restore.php

  ### NOTE:
   - All the contents are gone whenever restarting the docker container because those are stored in memory.
configuration:
- display: Long Running Instance
  name: longRunning
  defaultvalue: "true"
  type: 8
  required: false
- display: Listen Port
  name: longRunningPort
  defaultvalue: "8280"
  type: 0
  required: true
  additionalinfo: The port numer on which the server listens
- display: Incident type
  name: incidentType
  type: 13
  required: false
- display: URL from which to restore a backup
  name: restoreFrom
  type: 0
  required: false
  additionalinfo: The URL from which a backup file is downloaded to restore.
- display: ZIP password for the backup file
  name: backupfileArchivePassword
  type: 4
  required: false
  additionalinfo: The password to extract a backup file from the zip archive.
- display: Use system proxy settings
  name: proxy
  defaultvalue: "false"
  type: 8
  required: false
- display: Trust any certificate (not secure)
  name: insecure
  defaultvalue: "false"
  type: 8
  required: false
- display: Cron schedule to run the backup script
  name: cronSchedule
  type: 0
  required: false
  additionalinfo: 'Specify this in crontab format. e.g: */10 * * * *'
- display: Backup script in base64
  name: backupScript
  type: 4
  required: false
  additionalinfo: A backup file is given to the first argument of the script
script:
  script: |-
    import os
    import io
    import time
    import socket
    import select
    import subprocess
    import traceback
    import base64
    import binascii
    import zipfile
    import urllib.parse
    from tempfile import NamedTemporaryFile
    from socketserver import BaseServer, BaseRequestHandler, ThreadingTCPServer
    from multiprocessing import Process
    from typing import Dict, Any


    DOKUWIKI_PORT = '/tmp/dokuwiki.sock'

    DEFAULT_SOCKET_TIMEOUT = 30
    INTEGRATION_NAME = 'DocuWiki Server'


    def start_services(params: Dict[str, Any], test: bool):
        """
        Start services

        :param params: The integration parameters
        :param test: True to do a dry run, false otherwise.
        """
        if test:
            instance_name = 'test'
        else:
            instance_name = demisto.integrationInstance()
            if instance_name != urllib.parse.quote(instance_name):
                raise DemistoException(f'The instance name must not include any special/control charactors: {instance_name}')

        backup_file = ''
        if backupfile_url := params.get('restoreFrom'):
            # Download a backup file
            client = BaseClient(
                base_url='',
                verify=params.get('insecure', False),
                proxy=params.get('proxy', False))

            backup_data = client._http_request('GET', None, full_url=backupfile_url, resp_type='content')
            if backup_data[:4] == b'PK\x03\x04':
                with zipfile.ZipFile(io.BytesIO(backup_data), 'r') as z:
                    z.setpassword(params.get('backupfileArchivePassword', '').encode('utf-8'))
                    zinfolist = z.infolist()
                    if len(zinfolist) != 1:
                        if len(zinfolist) == 0:
                            raise DemistoException('No backup files in the archive.')
                        else:
                            raise DemistoException('2 or more files in the archive.')
                    backup_data = z.read(zinfolist[0].filename)

            with NamedTemporaryFile(mode='wb', delete=False) as f:
                f.write(backup_data)
                f.flush()
                backup_file = f.name

        # Test the encoding of the backup script
        b64backup_script = params.get('backupScript') or ''
        if b64backup_script:
            try:
                base64.b64decode(b64backup_script.encode())
            except binascii.Error:
                raise ValueError('Backup script must be in base64')

        # Run
        os.environ['DOKUWIKI_PORT'] = f'unix://{DOKUWIKI_PORT}'
        os.environ['DOKUWIKI_NAME'] = instance_name
        os.environ['DOKUWIKI_BACKUP_FILE'] = backup_file
        os.environ['DOKUWIKI_BACKUP_POST_SCRIPT'] = b64backup_script
        os.environ['DOKUWIKI_BACKUP_CRON_SCHEDULE'] = params.get('cronSchedule') or ''
        ret = subprocess.call('start.sh')
        demisto.debug(f'A start command has been requested: {ret}')


    class PortForwardingHandler(BaseRequestHandler):
        """
        Port Forwarding for the services
        """
        def __init__(self, request, client_address, server):
            BaseRequestHandler.__init__(self, request, client_address, server)

        def forward_tcp_tcp(self, endpoint: Any):
            """
            Port Forwarding: tcp-tcp:port
            """
            cs = self.request
            try:
                with socket.socket(socket.AF_UNIX, socket.SOCK_STREAM) as rs:
                    rs.connect(endpoint)
                    while True:
                        r, w, x = select.select([cs, rs], [], [])
                        if cs in r:
                            payload = cs.recv(1024)
                            if len(payload) == 0:
                                break
                            rs.send(payload)
                        if rs in r:
                            payload = rs.recv(1024)
                            if len(payload) == 0:
                                break
                            cs.send(payload)
            except Exception:
                demisto.debug(traceback.format_exc())
            finally:
                cs.close()

        def handle(self):
            self.forward_tcp_tcp(DOKUWIKI_PORT)
            self.request.close()


    ''' COMMAND FUNCTIONS '''


    def test_module(args, params):
        """
        Validates:
        """
        run_long_running(params, is_test=True)
        return 'ok', {}, {}


    def run_server(server: BaseServer, is_test=False):
        """
        Run the server

        :param server: The server instance
        :param is_test: Indicates whether it's test-module run or regular run
        :return: None
        """
        if is_test:
            svproc = Process(target=server.serve_forever)
            svproc.start()
            time.sleep(5)
            svproc.terminate()
        else:
            socket.setdefaulttimeout(DEFAULT_SOCKET_TIMEOUT)
            server.serve_forever()


    def run_long_running(params: Dict[str, Any], is_test=False):
        """
        Start the long running server

        :param params: Demisto params
        :param is_test: Indicates whether it's test-module run or regular run
        :return: None
        """
        try:
            longRunningPort = int(params['longRunningPort'])
            if longRunningPort <= 0:
                raise ValueError(f'Invalid long running port: {longRunningPort}')

            start_services(params, is_test)

            # Run the server
            with ThreadingTCPServer(('', longRunningPort), PortForwardingHandler) as server:
                run_server(server, is_test)
        except Exception as e:
            demisto.error(f'An error occurred in long running loop: {str(e)}')
            raise ValueError(str(e))


    def main():
        """
        Main
        """
        params = demisto.params()

        command = demisto.command()
        demisto.debug('Command being called is {}'.format(command))
        commands = {
            'test-module': test_module
        }

        try:
            if command == 'long-running-execution':
                run_long_running(params)
            else:
                readable_output, outputs, raw_response = commands[command](demisto.args(), params)
                return_outputs(readable_output, outputs, raw_response)
        except Exception as e:
            err_msg = f'Error in {INTEGRATION_NAME} Integration [{e}]'
            return_error(err_msg)


    if __name__ in ['__main__', '__builtin__', 'builtins']:
        main()
  type: python
  commands:
  - name: dokuwiki-restart
    arguments: []
    description: Restart the services
  dockerimage: spearmint/xsoar-dokuwiki:2.4.3.0123
  runonce: false
  longRunning: true
  longRunningPort: true
  subtype: python3
sourcemoduleid: ExportIndicators
